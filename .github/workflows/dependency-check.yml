name: Dependency Update Check

# Ce workflow vÃ©rifie les mises Ã  jour de dÃ©pendances disponibles
# et crÃ©e une issue si des mises Ã  jour sont dÃ©tectÃ©es

on:
  schedule:
    # ExÃ©cute tous les lundis Ã  9h00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Configure Maven settings for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF
      
      - name: Check for dependency updates
        id: check_updates
        run: |
          echo "## ðŸ“¦ VÃ©rification des mises Ã  jour de dÃ©pendances" > updates.md
          echo "" >> updates.md
          
          # VÃ©rifier les mises Ã  jour de dÃ©pendances
          ./mvnw versions:display-dependency-updates -B > dependency_updates.txt
          
          # VÃ©rifier les mises Ã  jour de plugins
          ./mvnw versions:display-plugin-updates -B > plugin_updates.txt
          
          # Parser et formater les rÃ©sultats
          if grep -q "The following dependencies in Dependencies have newer versions:" dependency_updates.txt; then
            echo "### ðŸ”„ Mises Ã  jour de dÃ©pendances disponibles" >> updates.md
            echo "" >> updates.md
            echo "\`\`\`" >> updates.md
            sed -n '/The following dependencies in Dependencies have newer versions:/,/^$/p' dependency_updates.txt >> updates.md
            echo "\`\`\`" >> updates.md
            echo "" >> updates.md
            echo "HAS_UPDATES=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Toutes les dÃ©pendances sont Ã  jour" >> updates.md
            echo "" >> updates.md
          fi
          
          if grep -q "The following plugin updates are available:" plugin_updates.txt; then
            echo "### ðŸ”Œ Mises Ã  jour de plugins disponibles" >> updates.md
            echo "" >> updates.md
            echo "\`\`\`" >> updates.md
            sed -n '/The following plugin updates are available:/,/^$/p' plugin_updates.txt >> updates.md
            echo "\`\`\`" >> updates.md
            echo "" >> updates.md
            echo "HAS_UPDATES=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tous les plugins sont Ã  jour" >> updates.md
            echo "" >> updates.md
          fi
          
          echo "---" >> updates.md
          echo "" >> updates.md
          echo "### ðŸ“ Actions recommandÃ©es" >> updates.md
          echo "" >> updates.md
          echo "1. Examinez les mises Ã  jour proposÃ©es" >> updates.md
          echo "2. Testez localement avec : \`./mvnw versions:use-latest-releases\`" >> updates.md
          echo "3. VÃ©rifiez la compatibilitÃ© avec \`./mvnw verify\`" >> updates.md
          echo "4. CrÃ©ez une branche et une PR avec les mises Ã  jour" >> updates.md
          echo "" >> updates.md
          echo "### ðŸ”— Liens utiles" >> updates.md
          echo "" >> updates.md
          echo "- [Maven Versions Plugin](https://www.mojohaus.org/versions-maven-plugin/)" >> updates.md
          echo "- [Spring Boot Releases](https://github.com/spring-projects/spring-boot/releases)" >> updates.md
          echo "- [DÃ©pendances du projet](pom.xml)" >> updates.md
          
          cat updates.md
      
      - name: Check if issue exists
        id: check_issue
        if: steps.check_updates.outputs.HAS_UPDATES == 'true'
        run: |
          # Chercher une issue ouverte avec le label "dependencies"
          ISSUE_NUMBER=$(gh issue list --label "dependencies" --state open --json number --jq '.[0].number')
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update issue
        if: steps.check_updates.outputs.HAS_UPDATES == 'true'
        run: |
          ISSUE_BODY=$(cat updates.md)
          ISSUE_TITLE="ðŸ“¦ Mises Ã  jour de dÃ©pendances disponibles - $(date +%Y-%m-%d)"
          
          if [ -n "${{ steps.check_issue.outputs.issue_number }}" ]; then
            # Mettre Ã  jour l'issue existante
            gh issue comment ${{ steps.check_issue.outputs.issue_number }} --body "$ISSUE_BODY"
            echo "âœ… Issue #${{ steps.check_issue.outputs.issue_number }} mise Ã  jour"
          else
            # CrÃ©er une nouvelle issue
            gh issue create \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "dependencies,maintenance"
            echo "âœ… Nouvelle issue crÃ©Ã©e"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            dependency_updates.txt
            plugin_updates.txt
            updates.md
          retention-days: 30
